---
- name: Log in and gather iteration nodes for all projects
  uri: 
    url: "https://dev.azure.com/{{ organization }}/{{ item.value }}/_apis/wit/classificationnodes/iterations?$depth=10&api-version=7.1"
    method: GET 
    headers: 
      Authorization: "Basic {{ (':' + pat) | b64encode }}" 
      Content-Type: "application/json" 
    body_format: json 
    return_content: yes 
  loop: "{{ ado_project_ids | dict2items }}"
  register: all_iterations
  tags: list_classifications


# - name: Save the registered variable to a local YAML file
#   ansible.builtin.copy:
#       content: "{{ all_iterations.results.0.json | to_nice_yaml(indent=4) }}"
#       dest: "./files/iterations_output.yml"
#   tags: list_classifications

# - name: Save only iteration JSON per project
#   ansible.builtin.copy:
#     content: >-
#       {{
#         all_iterations.results
#         | selectattr('json', 'defined')
#         | map(attribute='json')
#         | to_nice_yaml(indent=4)
#       }}
#     dest: "./iterations_output.yml"
#   tags: list_classifications

- name: Set fact with cleaner child data
  set_fact:
    all_iterations_facts: >-
      {{ all_iterations_facts | default([]) + [{
          'project': item.item.key,

          'top_level': {
            'name': item.json.name,
            'id': item.json.id,
            'path': item.json.path,
            'identifier': item.json.identifier,
            'attributes': item.json.attributes | default({})
          },

          'children': (
            item.json.children | default([])
            | json_query('[].{id:id,identifier:identifier,name:name,path:path,url:url,attributes:attributes}')
          ),

          'lower_level_children': (
            item.json.children | default([])
            | json_query('[].children[].{id:id,identifier:identifier,name:name,path:path,url:url,attributes:attributes}')
          )
      }] }}
  loop: "{{ all_iterations.results }}"
  when:
    - item.json is defined
    - item.json.children is defined
  loop_control:
    label: "{{ item.item.key }}"
  tags: list_classifications


# - name: Print the set_facts for iterations
#   debug:
#     msg: "Child: {{ child.name }} | Attributes: {{ child.attributes }}"
#   loop: "{{ all_iterations_facts[0].children }}"
#   loop_control:
#     loop_var: child
#   when: child.attributes is not none
#   tags: list_classifications

# - name: Print the set_facts for iterations
#   debug:
#     msg: "{{ item.top_level.name }} - Children: {{ item.children | map(attribute='name')  | list}}"
#   loop: "{{ all_iterations_facts}}"
#   tags: list_classifications

# - name: Print top-level attributes
#   debug:
#     msg: "Top Level: {{ all_iterations_facts[0].top_level.name }} | Attributes: {{ all_iterations_facts[0].top_level.attributes }}"
#   tags: list_classifications


# - name: Save the registered variable to a local YAML file
#   ansible.builtin.copy:
#       content: "{{ all_iterations_facts | map(attribute='lower_level_children') | to_nice_yaml(indent=4) }}"
#       dest: "/home/ec2-user/ado-work-items/files/child_output.yml"
#   tags: list_classifications

# - name: Save the registered variable to a local YAML file
#   ansible.builtin.copy:
#       content: "{{ all_iterations_facts | to_nice_yaml(indent=4) }}"
#       dest: "/home/ec2-user/ado-work-items/files/child_output.yml"
#   tags: list_classifications