---
- name: Log in and gather projects
  uri: 
    url: "https://dev.azure.com/{{ organization }}/_apis/projects?api-version=7.2-preview.4"
    method: GET 
    headers: 
      Authorization: "Basic {{ (':' + pat) | b64encode }}" 
      Content-Type: "application/json" 
    body_format: json 
    return_content: yes 
  register: result
  tags: list_projects

# - name: Projects Lists
#   debug:
#     msg: 
#       # {{ result.json.value }}
#       - Project Name: "{{ item.name }}" 
#       - Project ID: "{{ item.id }}"
#   loop: "{{ result.json.value}}"
#   loop_control:
#     label: "{{ item.name }} {{ item.id}}"
#   # tags: list_projects

- name: Debug blacklist variable
  debug:
    var: ado_project_blacklist

- name: Build Project Name â†’ ID Map (excluding blacklisted IDs)
  set_fact:
    ado_project_ids: >-
      {{
        dict(
          result.json.value
          | rejectattr('id', 'in', ado_project_blacklist | default([]))
          | map(attribute='name')
          | zip(
              result.json.value
              | rejectattr('id', 'in', ado_project_blacklist | default([]))
              | map(attribute='id')
          )
        )
      }}
  tags: list_projects

- name: Display Project Name from Ansible Facts
  debug:
    msg: '{{ ado_project_ids}}'
  tags: list_projects

- name: Output Project Name to default vars file
  blockinfile:
    # block: |
    #   ado_project_ids = {{ ado_project_ids.keys() | list | to_nice_yaml}}
    block: |
      ado_project_ids_list: 
      {% for key in ado_project_ids.keys() %}
       - {{ key }}
      {% endfor %}
    dest: "/home/ec2-user/ado-work-items/roles/ado_iterations_teams/vars/main.yml"
    marker: "# {mark} ANSIBLE PROJECT IDS"
  tags: list_projects

# - name: Append Project Name to default vars file
#   lineinfile:
#     path: "/home/ec2-user/ado-work-items/roles/ado_iterations_teams/vars/main.yml"
#     line: "ado_project_ids: [{{ ado_project_ids.keys() | join(', ') }}]"
#     insertafter: EOF
#   tags: list_projects